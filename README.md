# Microarray Data Processing Pipeline Scripts

This repository consists of Python scripts that perform a sequence of data processing tasks, annotation and calculations using pandas. It has a main script and six subscripts that are executed in sequence. The main input files for this use case are raw Asian Screening Array (ASA) file (.txt) and sample population file. The output file consists of traits, detected markers, their genotypic effect and others for reporting. Please see below for more details.

Other files that are assumed to be available for the pipeline usage (filtering & annotation) are mastervariant file and trait id file:

Mastervariant file is a text based table which consists of a list of variants and their information for annotation purposes.
Trait id file is a text based table which consists of a selection of variants based on different types of test for matching purposes. Different trait id files can be prepared based on the test of interest (different selection of variants). 

## Version

- Python 3.10.6

## Input files required for each run

1. Raw ASA file 
2. Sample population file (A file to indicate the population for each sample)
3. Mastervariant file (Declare the file path in config.py)
4. Trait id file 

## Usage

1. Navigate to the directory "files/",
    - create a new directory and named after "<asa_run_id>" (eg. 20XX391600XX)
2. In directory "<asa_run_id>/", 
    - create a new directory called "input"
3. In directory "input/", 
    - paste the ASA raw file (eg. 202X0316_20XX391600XX_V0.txt)
    - create a sample population file (Refer section: Sample Population File)

    The directory level is depicted as below:
    ```
    enterprise_system/
    > main.py # main script

    > scripts/ # dir with subscripts      
        - s1a_split_asa_by_sample_name.py
        - s1b_extract_asa_alleleplus_by_snpname.py
        - s2_generate_vcf_format.py
        - s3_generate_grr.py
        - s4_generate_trtscrMarkerGauge.py
        - s5_extract_finalresults.py
        > constants/ # dir with column variable names
            - config.py
            - raw_asa_dtype.py

    > database/ # dir with mastervariant and trait id files
        - mastervariant.txt
        - <test name>_traitid.txt 

    > files/
        > <asa_run_id>/ (Step 1)
            > input/ (Step 2)
                - <ASA_raw_data>.txt (Step 3)
                - <asa_run_id>_sample_population.tsv (Step 3)
    ```

4. Navigate to directory containing the main.py, run the following command.
    ```
    python3 main.py \
    -asa_run_id ASA_RUN_ID (eg. 20XX391600XX)
    -traitid_file PATH_TO_TRAITID_FILE (eg. database/<test name>_traitid.txt)

## Sample Population File

1. Create a file and name it following the filename format: <asa_run_id>_sample_population.tsv
2. In the file, create two columns separated by tab and name as following:

    - 1st column name: "sample_name"
        
        - Insert sample names that need to run the test

    - 2nd column name: "population"

        - Insert population accordingly (eg. EAS, AFR, AMR, EUR, SAS)

A sample population file is depicted as below:

    sample_name   population
    FM01730X      EAS
    FM01730Y      EAS
    FM017XXX      AFR      
    
## Final Output Files

An output directory will be autogenerated, ie "files/<asa_run_id>/output/". The output files generated by each subscript will be saved in the corresponding output directories.

    > enterprise_system/
        > files/
            > <asa_run_id>/ 
                > input/
                > output/ 
                    > s1a_asa_sample/
                    > s1b_asa_mastervariant/
                    > s2_asa_mastervariant_gt/
                    > s3_asa_mastervariant_grr/
                    > s4_asa_mastervariant_TrtscrMkrGaugeMeas/
                    > s5_asa_mastervariant_finalresults/

The final results to be sent for reporting are in the directory "output/s5_asa_mastervariant_finalresults/"

## Subscript Description

The main script will execute the subscripts in the following order, for more details may refer to the comments in the main script and subscripts.

constants/config.py: 

If there are any changes to the column names and mastervariant file path, you may change them using this file.

constants/raw_asa_dtype.py:

This is required by the python pandas warning. As asa raw file is a big file, the pandas seem to need a lot of memory to identify the data type of each column, so it suggests to specify the data type for each column upfront. In case asa raw file columns will be changed in the coming future, you may change them using this file.


1. s1a_split_asa_by_sample_name.py
    - Input File: ASA Raw File
    - Output File: ASA Sample Files
    - Function:	    
        - Split ASA raw file by Sample Name

2. s1b_extract_asa_alleleplus_by_snpname.py
    - Input File:	
        - ASA Sample Files
        - Master Variant Table
    - Output File: Asa Master Variant with	Allele PLUS-1, PLUS-2 and genotype (eg. GG)
    - Function:	    
        - Add PLUS-1 and PLUS-2 results columns to Master Variant Table using Illumina IDs (SNP Name) as Primary Key
        - Combine both as genotype (eg. GG)

3. s2_generate_vcf_format.py
    - Input File: Asa Master Variant with Allele PLUS-1, PLUS-2, genotype (eg. GG)
    - Output File: Asa Master Variant in VCF format (0/1)
    - Function:	    
        - Generate VCF format (0/1) for PLUS-1 and PLUS-2 results columns
        - For SNPs, VCF format is based on index (0/1, 0/2 etc)
        - For INDELs, VCF format is 0/1 based on the assumption that the first ALT is listed as the most common

4. s3_generate_grr.py
    - Input File: Asa Master Variant in VCF format (0/1)
    - Output File: Asa Master Variant with GRR
    - Function:	    
        - Generate genetic relative risk (GRR) based on Risk Code (0/1), genotype (0/1), population frequency (p) and odds-ratios (OR)
        - When Risk Code is 1,

            - Relative risk for 0/0 = 1/average population risk
            - Relative risk for 0/1 = OR/average population risk
            - Relative risk for 1/1 = OR^2/average population risk

        - When Risk Code is 0,

            - Relative risk for 0/0 = OR^2/average population risk
            - Relative risk for 0/1 = OR/average population risk
            - Relative risk for 1/1 = 1/average population risk

5. s4_generate_trtscrMarkerGauge.py
    - Input File: 
        - Asa Master Variant with GRR
        - Trait ID file
    - Output File: Asa Master Variant with number of marker, total number of marker, trait score, gauge and genotypic effect
    - Function:	Generate the following  
        - Number of marker for each variant based on genotype
        - Total number of marker from the same trait 
        - Trait score based on multiplying GRR of variants from the same trait
        - Gauge based on trait score
        - Genotypic effect based on gauge

6. s5_extract_finalresults.py
    - Input File: Asa Master Variant with number of marker, total number of marker, trait score, gauge and genotypic effect
    - Output File: Selected columns and filtered rows from Asa Master Variant
    - Function:	Select columns and filter rows to send to System Developer for reporting
        - Situation 1: Trait without marker

            For TRAIT_NAME that have 0 TOTAL MARKER detected, it will be output only once, the columns: GENE and GENOTYPE will be replaced with '.'

        - Situation 2: Trait with marker(s)

            a. For TRAIT_NAME that have more than 0 TOTAL MARKER detected, only variants with MARKER detected will be output. (variants with 0 MARKER will be filtered out)

            b. For TRAIT_NAME that have more than 0 TOTAL MARKER detected, if among the variants with MARKER detected, the GENE is the same, then the GENOTYPE will be aggregated (joined by comma)
